<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude CLI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background: #161b22;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #header h1 {
            font-size: 16px;
            color: #58a6ff;
            flex: 1;
        }
        #status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #238636;
            color: white;
        }
        #status.loading {
            background: #d29922;
        }
        #status.error {
            background: #da3633;
        }
        #terminal {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        .line {
            white-space: pre-wrap;
            word-break: break-word;
            margin-bottom: 4px;
        }
        .prompt { color: #58a6ff; }
        .output { color: #c9d1d9; }
        .error { color: #f85149; }
        .success { color: #3fb950; }
        .info { color: #8b949e; }
        .claude { color: #a371f7; }
        #input-area {
            background: #161b22;
            border-top: 1px solid #30363d;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
        }
        #input {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px 12px;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        #input:focus {
            border-color: #58a6ff;
        }
        #send-btn {
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #send-btn:disabled {
            background: #30363d;
            cursor: not-allowed;
        }
        #login-btn {
            background: #a371f7;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        .typing {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #58a6ff;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ü§ñ Claude CLI</h1>
        <button id="login-btn" style="display:none;">Î°úÍ∑∏Ïù∏</button>
        <span id="status" class="loading">Ï¥àÍ∏∞Ìôî Ï§ë...</span>
    </div>
    <div id="terminal"></div>
    <div id="input-area">
        <input type="text" id="input" placeholder="ClaudeÏóêÍ≤å ÏßàÎ¨∏ÌïòÏÑ∏Ïöî..." disabled>
        <button id="send-btn" disabled>Ï†ÑÏÜ°</button>
    </div>

    <script type="module">
        import { WebContainer } from 'https://esm.sh/@webcontainer/api';

        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');
        const loginBtn = document.getElementById('login-btn');
        const status = document.getElementById('status');

        let webcontainer = null;
        let isReady = false;
        let isLoggedIn = false;
        let apiKey = null;

        // ANSI escape codes Ï†úÍ±∞
        function stripAnsi(str) {
            return str.replace(/\x1B\[[0-9;]*[a-zA-Z]/g, '')
                      .replace(/\[[\d;]*[A-Za-z]/g, '')
                      .replace(/[\x00-\x1F]/g, '');
        }

        function log(text, type = 'output') {
            // ANSI ÏΩîÎìú Ï†úÍ±∞
            const cleanText = stripAnsi(text).trim();
            if (!cleanText) return;

            const line = document.createElement('div');
            line.className = `line ${type}`;

            // URL Í∞êÏßÄÌï¥ÏÑú ÎßÅÌÅ¨Î°ú Î≥ÄÌôò
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            if (urlRegex.test(cleanText)) {
                line.innerHTML = cleanText.replace(urlRegex, '<a href="$1" target="_blank" style="color:#58a6ff;">$1</a>');
            } else {
                line.textContent = cleanText;
            }

            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function setStatus(text, type = '') {
            status.textContent = text;
            status.className = type;
        }

        async function init() {
            try {
                log('WebContainer Î∂ÄÌåÖ Ï§ë...', 'info');
                webcontainer = await WebContainer.boot();
                log('‚úì WebContainer Ï§ÄÎπÑÎê®', 'success');

                // package.json ÏÉùÏÑ±
                log('Claude CLI ÏÑ§Ïπò Ï§ë...', 'info');
                await webcontainer.fs.writeFile('/package.json', JSON.stringify({
                    name: "claude-workspace",
                    type: "module",
                    dependencies: {
                        "@anthropic-ai/claude-code": "latest"
                    }
                }, null, 2));

                // npm install
                const installProcess = await webcontainer.spawn('npm', ['install']);
                installProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        if (data.includes('added') || data.includes('error')) {
                            log(data.trim(), 'info');
                        }
                    }
                }));

                const exitCode = await installProcess.exit;
                if (exitCode !== 0) {
                    throw new Error('npm install Ïã§Ìå®');
                }

                log('‚úì Claude CLI ÏÑ§Ïπò ÏôÑÎ£å', 'success');
                log('', 'output');

                // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
                await checkLoginStatus();

            } catch (error) {
                log(`Ïò§Î•ò: ${error.message}`, 'error');
                setStatus('Ïò§Î•ò', 'error');
            }
        }

        async function checkLoginStatus() {
            // Î∞îÎ°ú Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÌëúÏãú (Ïù∏Ï¶ù ÌôïÏù∏ ÏÉùÎûµ)
            log('Claude Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'info');
            log('Î°úÍ∑∏Ïù∏ Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.', 'info');
            loginBtn.style.display = 'block';
            setStatus('Î°úÍ∑∏Ïù∏ ÌïÑÏöî', 'error');
            isReady = true;
        }

        async function doLogin() {
            loginBtn.disabled = true;
            setStatus('Î°úÍ∑∏Ïù∏ Ï§ë...', 'loading');
            log('', 'output');
            log('Claude Î°úÍ∑∏Ïù∏ ÏãúÏûë...', 'info');
            log('(Ïû†Ïãú Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî)', 'info');

            try {
                // claude login ÏãúÎèÑ (non-interactive ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï)
                const loginProcess = await webcontainer.spawn('npx', ['claude', 'login'], {
                    env: {
                        FORCE_COLOR: '0',
                        CI: 'true',
                        TERM: 'dumb',
                        NO_COLOR: '1'
                    }
                });

                let outputBuffer = '';

                // stdoutÍ≥º stderr Î™®Îëê Ï∫°Ï≤ò
                const outputPromise = loginProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        outputBuffer += data;
                        log(data, 'info');

                        // URL Í∞êÏßÄÌï¥ÏÑú ÏûêÎèôÏúºÎ°ú Ïó¥Í∏∞
                        const urlMatch = data.match(/(https:\/\/[^\s\)]+)/);
                        if (urlMatch) {
                            log('üîó Ïù∏Ï¶ù ÎßÅÌÅ¨Î•º Ïó¨Îäî Ï§ë...', 'success');
                            window.open(urlMatch[1], '_blank');
                        }
                    }
                }));

                // 5Ï¥à ÌõÑÏóêÎèÑ Ï∂úÎ†• ÏóÜÏúºÎ©¥ ÏïàÎÇ¥
                setTimeout(() => {
                    if (!outputBuffer) {
                        log('ÏùëÎãµ ÎåÄÍ∏∞ Ï§ë... CLIÍ∞Ä ÎäêÎ¶¥ Ïàò ÏûàÏäµÎãàÎã§.', 'info');
                    }
                }, 5000);

                const exitCode = await loginProcess.exit;
                log(`(Ï¢ÖÎ£å ÏΩîÎìú: ${exitCode})`, 'info');

                if (exitCode === 0) {
                    log('‚úì Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!', 'success');
                    isLoggedIn = true;
                    loginBtn.style.display = 'none';
                    enableChat();
                } else {
                    log('', 'output');
                    log('Ïù∏Ï¶ù URLÏù¥ Ïó¥Î¶¨ÏßÄ ÏïäÏïòÎã§Î©¥:', 'info');
                    log('https://console.anthropic.com ÏóêÏÑú API ÌÇ§Î•º Î∞úÍ∏âÎ∞õÏïÑ', 'info');
                    log('ÏûÖÎ†•Ï∞ΩÏóê /apikey YOUR_KEY ÌòïÌÉúÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'info');
                    loginBtn.disabled = false;
                    setStatus('Î°úÍ∑∏Ïù∏ ÌïÑÏöî', 'error');
                }
            } catch (error) {
                log(`Ïò§Î•ò: ${error.message}`, 'error');
                log('', 'output');
                log('ÎåÄÏïà: API ÌÇ§ ÏÇ¨Ïö©', 'info');
                log('https://console.anthropic.com ÏóêÏÑú API ÌÇ§ Î∞úÍ∏â ÌõÑ', 'info');
                log('ÏûÖÎ†•Ï∞ΩÏóê /apikey YOUR_KEY ÏûÖÎ†•', 'info');
                loginBtn.disabled = false;
            }
        }

        function enableChat() {
            log('', 'output');
            log('üéâ Claude CLI Ï§ÄÎπÑ ÏôÑÎ£å!', 'success');
            log('ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'info');
            log('', 'output');

            setStatus('Ï§ÄÎπÑÎê®', '');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        async function sendMessage() {
            const message = input.value.trim();
            if (!message || !isReady) return;

            // Î°úÍ∑∏Ïù∏ Î™ÖÎ†πÏñ¥ Ï≤òÎ¶¨
            if (message === '/login') {
                input.value = '';
                await doLogin();
                return;
            }

            // API ÌÇ§ ÏÑ§Ï†ï
            if (message.startsWith('/apikey ')) {
                const key = message.replace('/apikey ', '').trim();
                if (key) {
                    apiKey = key;
                    log('API ÌÇ§ ÏÑ§Ï†ï Ï§ë...', 'info');
                    log('‚úì API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
                    isLoggedIn = true;
                    loginBtn.style.display = 'none';
                    enableChat();
                }
                return;
            }

            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;
            setStatus('ÏùëÎãµ Ï§ë...', 'loading');

            log(`> ${message}`, 'prompt');

            try {
                // API ÌÇ§Í∞Ä ÏûàÏúºÎ©¥ ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï†ÑÎã¨
                const spawnOptions = apiKey ? { env: { ANTHROPIC_API_KEY: apiKey } } : {};

                const claudeProcess = await webcontainer.spawn('npx', [
                    'claude',
                    '--print',
                    message
                ], spawnOptions);

                claudeProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        const lines = data.split('\n');
                        lines.forEach(line => {
                            if (line.trim()) {
                                // Î°úÍ∑∏Ïù∏ ÌïÑÏöî Î©îÏãúÏßÄ Í∞êÏßÄ
                                if (line.includes('Invalid API key') || line.includes('/login')) {
                                    log(line, 'error');
                                    loginBtn.style.display = 'block';
                                } else {
                                    log(line, 'claude');
                                }
                            }
                        });
                    }
                }));

                await claudeProcess.exit;
                log('', 'output');

            } catch (error) {
                log(`Ïò§Î•ò: ${error.message}`, 'error');
            }

            setStatus('Ï§ÄÎπÑÎê®', '');
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        sendBtn.addEventListener('click', sendMessage);
        loginBtn.addEventListener('click', doLogin);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Ï¥àÍ∏∞Ìôî
        init();
    </script>
</body>
</html>
