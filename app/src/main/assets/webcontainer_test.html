<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebContainers Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 16px;
            min-height: 100vh;
        }
        h1 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #4ade80;
        }
        #status {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        #terminal {
            background: #000;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        button {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 16px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª WebContainers í…ŒìŠ¤íŠ¸</h1>
    <div id="status">ìƒíƒœ: ì´ˆê¸°í™” ì¤‘...</div>
    <div id="terminal"></div>
    <button onclick="runTest()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>

    <script type="module">
        import { WebContainer } from 'https://esm.sh/@webcontainer/api';

        const statusEl = document.getElementById('status');
        const terminalEl = document.getElementById('terminal');

        let webcontainer = null;

        function log(msg, type = '') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            terminalEl.appendChild(span);
            terminalEl.scrollTop = terminalEl.scrollHeight;
        }

        function setStatus(msg, type = '') {
            statusEl.innerHTML = `ìƒíƒœ: <span class="${type}">${msg}</span>`;
        }

        async function init() {
            try {
                setStatus('WebContainer ë¶€íŒ… ì¤‘...', 'info');
                log('WebContainer ì´ˆê¸°í™” ì‹œì‘...', 'info');

                webcontainer = await WebContainer.boot();

                setStatus('ì¤€ë¹„ë¨!', 'success');
                log('âœ… WebContainer ë¶€íŒ… ì„±ê³µ!', 'success');
                log('');

                // ê¸°ë³¸ íŒŒì¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
                log('íŒŒì¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸...', 'info');
                await webcontainer.fs.writeFile('/test.txt', 'Hello from WebContainer!');
                const content = await webcontainer.fs.readFile('/test.txt', 'utf-8');
                log(`íŒŒì¼ ì½ê¸°: ${content}`, 'success');
                log('');

                // Node.js ë²„ì „ í™•ì¸
                log('Node.js ë²„ì „ í™•ì¸...', 'info');
                const nodeProcess = await webcontainer.spawn('node', ['--version']);
                nodeProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        log(`Node.js: ${data}`, 'success');
                    }
                }));
                await nodeProcess.exit;

                // npm ë²„ì „ í™•ì¸
                log('npm ë²„ì „ í™•ì¸...', 'info');
                const npmProcess = await webcontainer.spawn('npm', ['--version']);
                npmProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        log(`npm: ${data}`, 'success');
                    }
                }));
                await npmProcess.exit;

                log('');
                log('ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!', 'success');
                log('Claude CLI ì„¤ì¹˜ ê°€ëŠ¥!', 'success');

                window.webcontainer = webcontainer;

            } catch (error) {
                setStatus('ì˜¤ë¥˜ ë°œìƒ', 'error');
                log(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
                log('');
                log('ìƒì„¸:', 'error');
                log(error.stack || error.toString(), 'error');
            }
        }

        window.runTest = async function() {
            if (!webcontainer) {
                log('WebContainerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            log('');
            log('=== Claude CLI ì„¤ì¹˜ í…ŒìŠ¤íŠ¸ ===', 'info');
            log('');

            try {
                // 1. package.json ìƒì„±
                log('package.json ìƒì„± ì¤‘...', 'info');
                await webcontainer.fs.writeFile('/package.json', JSON.stringify({
                    name: "claude-workspace",
                    type: "module",
                    dependencies: {
                        "@anthropic-ai/claude-code": "latest"
                    }
                }, null, 2));
                log('âœ… package.json ìƒì„± ì™„ë£Œ', 'success');
                log('');

                // 2. npm install (ë¡œì»¬ ì„¤ì¹˜)
                log('npm install ì‹¤í–‰ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)', 'info');
                const installProcess = await webcontainer.spawn('npm', ['install']);

                installProcess.output.pipeTo(new WritableStream({
                    write(data) {
                        log(data);
                    }
                }));

                const exitCode = await installProcess.exit;

                if (exitCode === 0) {
                    log('');
                    log('âœ… Claude CLI ì„¤ì¹˜ ì„±ê³µ!', 'success');
                    log('');

                    // 3. Claude ë²„ì „ í™•ì¸
                    log('Claude ë²„ì „ í™•ì¸ ì¤‘...', 'info');
                    const claudeProcess = await webcontainer.spawn('npx', ['claude', '--version']);
                    claudeProcess.output.pipeTo(new WritableStream({
                        write(data) {
                            log(`Claude: ${data}`, 'success');
                        }
                    }));
                    await claudeProcess.exit;
                } else {
                    log('');
                    log(`âŒ ì„¤ì¹˜ ì‹¤íŒ¨ (exit code: ${exitCode})`, 'error');
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
